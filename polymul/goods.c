#include "polymul_768x768.h"
#include <stdint.h>
#include <stddef.h>

typedef int32_t T;
typedef int64_t T2;

#define P0 512
#define P1 3
#define N (P0 * P1)
#define Qbig 6984193
#define Qsmall 4591

T twiddlesForward[] = {1, 1, -1888710, 1, -1888710, 1189439, 2249918, 1, -1888710, 1189439, 2249918, -2631832, -1472661, 2474861, 2161414, 1, -1888710, 1189439, 2249918, -2631832, -1472661, 2474861, 2161414, 3285557, -1896777, -639662, 3326687, -2475826, -2430637, -928322, -1718679, 1, -1888710, 1189439, 2249918, -2631832, -1472661, 2474861, 2161414, 3285557, -1896777, -639662, 3326687, -2475826, -2430637, -928322, -1718679, -995969, 2004142, 476883, 1806736, -421236, 2268351, -2489170, 1547259, -1989250, -2320078, -594596, 3081918, -219379, -922828, -1503708, 2126774, 1, -1888710, 1189439, 2249918, -2631832, -1472661, 2474861, 2161414, 3285557, -1896777, -639662, 3326687, -2475826, -2430637, -928322, -1718679, -995969, 2004142, 476883, 1806736, -421236, 2268351, -2489170, 1547259, -1989250, -2320078, -594596, 3081918, -219379, -922828, -1503708, 2126774, 1138199, -212083, 2309241, 2275530, -236096, -2894311, -1358000, 126873, 1391923, 2150379, -2433646, 471114, -485734, 1991625, 2434313, -3085944, 430192, -1839665, -2773664, -678456, 487100, 2181925, 2006585, 3429012, 1262762, -1054608, -270904, -2885340, 1909715, -2137309, -542084, -1317002, 1, -1888710, 1189439, 2249918, -2631832, -1472661, 2474861, 2161414, 3285557, -1896777, -639662, 3326687, -2475826, -2430637, -928322, -1718679, -995969, 2004142, 476883, 1806736, -421236, 2268351, -2489170, 1547259, -1989250, -2320078, -594596, 3081918, -219379, -922828, -1503708, 2126774, 1138199, -212083, 2309241, 2275530, -236096, -2894311, -1358000, 126873, 1391923, 2150379, -2433646, 471114, -485734, 1991625, 2434313, -3085944, 430192, -1839665, -2773664, -678456, 487100, 2181925, 2006585, 3429012, 1262762, -1054608, -270904, -2885340, 1909715, -2137309, -542084, -1317002, 23955, -445796, -2496195, -231691, 774651, -435412, 3465071, 2849661, 647018, 1866623, 216232, 1144955, 1355126, 1307706, -282998, 862290, -434107, -121072, -2407483, -683141, 1450505, 1326665, 2972484, -522906, 665089, 2739404, -2777653, -2558513, -3110809, -1373895, 3142354, -2816765, -732427, -2939954, 3059595, -1305215, 1516650, -1136094, 1480994, 1118760, 978083, -3078623, -930959, -920018, -92432, 354492, 2940558, -3089808, -3419508, 1082755, -2493111, -196369, -2106003, -1687037, 2527449, 888587, 923827, -1308559, -1190023, -2745772, 758675, 1881788, -2007433, -1183129};
T twiddlesInverse[] = {1, 1888710, -2249918, -1189439, -2161414, -2474861, 1472661, 2631832, 1718679, 928322, 2430637, 2475826, -3326687, 639662, 1896777, -3285557, -2126774, 1503708, 922828, 219379, -3081918, 594596, 2320078, 1989250, -1547259, 2489170, -2268351, 421236, -1806736, -476883, -2004142, 995969, 1317002, 542084, 2137309, -1909715, 2885340, 270904, 1054608, -1262762, -3429012, -2006585, -2181925, -487100, 678456, 2773664, 1839665, -430192, 3085944, -2434313, -1991625, 485734, -471114, 2433646, -2150379, -1391923, -126873, 1358000, 2894311, 236096, -2275530, -2309241, 212083, -1138199, 1183129, 2007433, -1881788, -758675, 2745772, 1190023, 1308559, -923827, -888587, -2527449, 1687037, 2106003, 196369, 2493111, -1082755, 3419508, 3089808, -2940558, -354492, 92432, 920018, 930959, 3078623, -978083, -1118760, -1480994, 1136094, -1516650, 1305215, -3059595, 2939954, 732427, 2816765, -3142354, 1373895, 3110809, 2558513, 2777653, -2739404, -665089, 522906, -2972484, -1326665, -1450505, 683141, 2407483, 121072, 434107, -862290, 282998, -1307706, -1355126, -1144955, -216232, -1866623, -647018, -2849661, -3465071, 435412, -774651, 231691, 2496195, 445796, -23955, 1, 1888710, -2249918, -1189439, -2161414, -2474861, 1472661, 2631832, 1718679, 928322, 2430637, 2475826, -3326687, 639662, 1896777, -3285557, -2126774, 1503708, 922828, 219379, -3081918, 594596, 2320078, 1989250, -1547259, 2489170, -2268351, 421236, -1806736, -476883, -2004142, 995969, 1317002, 542084, 2137309, -1909715, 2885340, 270904, 1054608, -1262762, -3429012, -2006585, -2181925, -487100, 678456, 2773664, 1839665, -430192, 3085944, -2434313, -1991625, 485734, -471114, 2433646, -2150379, -1391923, -126873, 1358000, 2894311, 236096, -2275530, -2309241, 212083, -1138199, 1, 1888710, -2249918, -1189439, -2161414, -2474861, 1472661, 2631832, 1718679, 928322, 2430637, 2475826, -3326687, 639662, 1896777, -3285557, -2126774, 1503708, 922828, 219379, -3081918, 594596, 2320078, 1989250, -1547259, 2489170, -2268351, 421236, -1806736, -476883, -2004142, 995969, 1, 1888710, -2249918, -1189439, -2161414, -2474861, 1472661, 2631832, 1718679, 928322, 2430637, 2475826, -3326687, 639662, 1896777, -3285557, 1, 1888710, -2249918, -1189439, -2161414, -2474861, 1472661, 2631832, 1, 1888710, -2249918, -1189439, 1, 1888710, 1};

static T cmod(T2 a, T2 Q)
{
    T2 t = a % Q;
    if (t > Q / 2)
        t -= Q;
    if (t < -Q / 2)
        t += Q;
    return t;
}

static void goodsPermutation(T *g, T *p, size_t p0, size_t p1)
{
    size_t i;
    for (i = 0; i < p0 * p1; i++)
    {
        g[(i % p1) * p0 + i % p0] = p[i];
    }
}

static void goodsPermutationInverse(T *p, T *g, size_t p0, size_t p1)
{
    size_t i;
    for (i = 0; i < p0 * p1; i++)
    {
        p[i] = g[(i % p1) * p0 + i % p0];
    }
}

static void ntt_ct(T *a, T *twiddles, size_t n, T q)
{
    (void)n;
    size_t logn = 8;

    for (size_t i = 0; i < logn; i++)
    {
        size_t distance = 1U << (logn - 1 - i);
        for (size_t j = 0; j < (1U << i); j++)
        {
            T twiddle = *twiddles;
            twiddles++;
            for (size_t k = 0; k < distance; k++)
            {
                size_t idx0 = 2 * j * distance + k;
                size_t idx1 = idx0 + distance;
                T a0 = a[idx0];
                T a1 = cmod(((T2)a[idx1] * twiddle), q);
                a[idx0] = cmod(a0 + a1, q);
                a[idx1] = cmod(a0 - a1, q);
            }
        }
    }
}

static void invntt_gs(T *a, T *twiddles, size_t n, T q)
{
    (void)n;
    size_t logn = 8;
    for (size_t i = 0; i < logn; i++)
    {
        size_t distance = 1 << i;
        for (size_t j = 0; j < (1U << (logn - 1 - i)); j++)
        {
            T twiddle = *twiddles;
            twiddles++;
            for (size_t k = 0; k < distance; k++)
            {
                size_t idx0 = 2 * j * distance + k;
                size_t idx1 = idx0 + distance;
                T a0 = cmod(a[idx0] + a[idx1], q);
                T a1 = cmod(a[idx0] - a[idx1], q);
                a[idx0] = a0;
                a[idx1] = cmod((T2)a1 * twiddle, q);
            }
        }
    }

    T ninv = 6956911;
    for (size_t i = 0; i < n; i++)
    {
        a[i] = cmod((T2)a[i] * ninv, q);
    }
}


static void dump(T *poly){
    size_t i;
    unsigned char str[100];
    for(i=0;i<10;i++){
        sprintf(str, "%d,", poly[i]);
        hal_send_str(str);
    }
}

void gf_polymul_768x768(short *h, short *f, short *g)
{
    T h32[N];
    T f32[N];
    T g32[N];
    size_t i, j, k;
    for (i = 0; i < 768; i++)
    {
        f32[i] = cmod(f[i], Qsmall);
        g32[i] = cmod(g[i], Qsmall);
    }

    dump(f32);

    dump(g32);

    T fgood[P1][P0];
    T ggood[P1][P0];
    goodsPermutation(fgood[0], f32, P0, P1);
    goodsPermutation(ggood[0], g32, P0, P1);

    for (i = 0; i < P1; i++)
    {
        ntt_ct(fgood[i], twiddlesForward, P0, Qbig);
        ntt_ct(ggood[i], twiddlesForward, P0, Qbig);
    }

    T hgood[P1][P0] = {0};
    for (i = 0; i < P0; i++)
    {
        for (j = 0; j < P1; j++)
        {
            for (k = 0; k < P1; k++)
            {
                hgood[(j + k) % P1][i] += cmod((T2)fgood[j][i] * ggood[k][i], Qbig);
            }
        }
    }

    for (i = 0; i < P1; i++)
    {
        invntt_gs(hgood[i], twiddlesInverse, P0, Qbig);
    }

    goodsPermutationInverse(h32, hgood[0], P0, P1);

    for (i = 0; i < 2 * 768 - 1; i++)
    {
        h[i] = cmod(h32[i], Qsmall);
    }

    for(i=0;i<1<<30;i++) {
        asm("nop");
    }
}
